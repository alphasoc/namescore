machine:
  environment:
    PKG: "github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME"
    BUILD_DIR: "$HOME/build"
  post:
    - sudo rm -rf /usr/local/go
    - curl -s -o - https://storage.googleapis.com/golang/go1.8.linux-amd64.tar.gz | sudo tar -C /usr/local -xzf -
    - sudo apt-get install --quiet --yes libpcap-dev
    - go get github.com/aktau/github-release

compile:
  override:
    - GOOS=linux GOARCH=amd64 GOBIN="$BUILD_DIR" go install $PKG
    - mv "$BUILD_DIR/namescore" namescore_linux-amd64
    - GOOS=linux GOARCH=amd64 GOBIN="$BUILD_DIR" go install -ldflags "-linkmode external -extldflags -static" $PKG
    - mv "$BUILD_DIR/namescore" namescore_pcap_linux-amd64
    - GOOS=windows GOARCH=amd64 GOBIN="$BUILD_DIR" go install $PKG
    - mv "$BUILD_DIR/namescore" namescore_windows-amd64.exe

deployment:
  release:
    tag: /v[0-9]+\.[0-9]+\.[0-9]+/
    commands:
      - github-release release \
          --user alphasoc \
          --repo namescore \
          --tag $CIRCLE_TAG
          --name "namescoure $CIRCLE_TAG"
          --file "$BUILD_DIR/namescore.linux-amd64"
